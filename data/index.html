<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ESP32 æ§åˆ¶ä¸­å¿ƒ</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>ESP32 æ§åˆ¶ä¸­å¿ƒ</h1>

  <div class="section">
    <h2>Cordset</h2>
    <div id="mcuInfo"></div>
    <div id="mcuStatus">Not Ready</div>
    <button id="mcu8A">8A</button>
    <button id="mcu12A">12A</button>
    <button id="mcu16A">16A</button>
    <button id="mcu24A">24A</button>
    <button id="mcu32A">32A</button>
    <button id="mcu40A">40A</button>
  </div>

  <!-- OTA éŸŒé«”æ›´æ–° -->
  <div class="section">
    <h2>ESP32 OTA éŸŒé«”æ›´æ–°</h2>
    <input type="file" id="firmwareInput">
    <button id="uploadBtn">ä¸Šå‚³ä¸¦æ›´æ–°</button>
    <p id="uploadStatus"></p>
  </div>

  <!-- ğŸ”’ Secure Boot OTA éŸŒé«”æ›´æ–° -->
  <div class="section">
    <h2>ESP32 Secure Boot OTA éŸŒé«”æ›´æ–°</h2>
    <input type="text" id="binUrl" placeholder="firmware.bin URL"><br><br>
    <input type="text" id="sigUrl" placeholder="firmware.sig URL"><br><br>
    <button onclick="doSecureOTA()">é–‹å§‹ Secure OTA</button>
    <p id="secureStatus"></p>
  </div>

  <!-- SPIFFS æª”æ¡ˆç¸½ç®¡ -->
  <div class="section">
    <h2>SPIFFS æª”æ¡ˆç¸½ç®¡</h2>
    <p id="spiffsUsage">ä½¿ç”¨é‡ï¼š-- / --</p> 
    <ul id="fileList"></ul>

    <h3>ä¸Šå‚³æª”æ¡ˆ</h3>
    <input type="file" id="fileInput">
    <button id="fileUploadBtn">ä¸Šå‚³</button>
    <p id="fileStatus"></p>
  </div>

  <script>
    const ws = new WebSocket(`ws://${location.host}/ws`);
    const mcuInfo = document.getElementById("mcuInfo");
    const mcuStatus = document.getElementById("mcuStatus");

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      mcuInfo.textContent = `version: ${data.version}, max current: ${data.max} A`;
      mcuStatus.textContent = `${data.state}, ${data.temp} Â°C, ${data.power} W`;
    };

    mcu8A.onclick = () =>ws.send("cset=0")
    mcu12A.onclick = () =>ws.send("cset=1")
    mcu16A.onclick = () =>ws.send("cset=2")
    mcu24A.onclick = () =>ws.send("cset=3")
    mcu32A.onclick = () =>ws.send("cset=4")
    mcu40A.onclick = () =>ws.send("cset=5")

    // OTA éŸŒé«”ä¸Šå‚³
    document.getElementById("uploadBtn").onclick = async () => {
      const file = document.getElementById("firmwareInput").files[0];
      if (!file) return alert("è«‹é¸æ“‡ .bin æª”æ¡ˆ");

      const formData = new FormData();
      formData.append("update", file);

      const res = await fetch("/upload", {
        method: "POST",
        body: formData
      });

      document.getElementById("uploadStatus").textContent = await res.text();
    };

    // ğŸ”’ Secure Boot OTA
    function doSecureOTA() {
      const bin = document.getElementById("binUrl").value;
      const sig = document.getElementById("sigUrl").value;
      if (!bin || !sig) return alert("è«‹å¡«å…¥ bin èˆ‡ sig ä¸‹è¼‰ç¶²å€");

      fetch(`/secure_ota?bin=${encodeURIComponent(bin)}&sig=${encodeURIComponent(sig)}`)
        .then(res => res.text())
        .then(txt => document.getElementById("secureStatus").innerText = txt)
        .catch(err => document.getElementById("secureStatus").innerText = "éŒ¯èª¤: " + err);
    }

    // å–å¾— SPIFFS ä½¿ç”¨é‡
    async function fetchSPIFFSUsage() {
      const info = await fetch("/spiffs_usage").then(res => res.json());
      const kb = n => (n / 1024).toFixed(1) + " KB";
      document.getElementById("spiffsUsage").textContent =
        `ä½¿ç”¨é‡ï¼š${kb(info.used)} / ${kb(info.total)}`;
    }

    // SPIFFS æª”æ¡ˆåˆ—è¡¨ + åˆªé™¤
    async function refreshFiles() {
      const list = await fetch("/files").then(res => res.json());
      const ul = document.getElementById("fileList");
      ul.innerHTML = "";

      list.forEach(file => {
        const li = document.createElement("li");
        const download = document.createElement("a");
        download.href = file;
        download.textContent = file;
        download.download = "";

        const delBtn = document.createElement("button");
        delBtn.textContent = "åˆªé™¤";
        delBtn.onclick = async () => {
          await fetch("/delete", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `file=${encodeURIComponent(file)}`
          });
          refreshFiles(); // å†æ¬¡åˆ·æ–°åˆ—è¡¨
        };

        li.appendChild(download);
        li.appendChild(delBtn);
        ul.appendChild(li);
      });
      fetchSPIFFSUsage(); // âœ… æ¯æ¬¡åˆ·æ–°æ™‚ä¸€ä½µæ›´æ–°ä½¿ç”¨é‡
    }

    // ä¸Šå‚³æª”æ¡ˆ
    document.getElementById("fileUploadBtn").onclick = async () => {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("è«‹é¸æ“‡æª”æ¡ˆ");

      const formData = new FormData();
      formData.append("file", file);

      const res = await fetch("/uploadFile", {
        method: "POST",
        body: formData
      });

      document.getElementById("fileStatus").textContent = await res.text();
      refreshFiles(); // âœ… ä¸Šå‚³å¾Œåˆ·æ–°æª”æ¡ˆæ¸…å–®èˆ‡ä½¿ç”¨é‡
    };

    // åˆå§‹åŒ–
    refreshFiles(); // âœ… é é¢è¼‰å…¥æ™‚åˆ·æ–°æª”æ¡ˆæ¸…å–®èˆ‡ä½¿ç”¨é‡
  </script>
</body>
</html>

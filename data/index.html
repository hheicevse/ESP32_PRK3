<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ESP32 控制中心</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>ESP32 控制中心</h1>

  <!-- 即時電流顯示與 LED 控制 -->
  <div class="section">
    <h2>電流監控</h2>
    <div id="current">-- A</div>
    <button id="ledBtn">LED OFF</button>
  </div>

  <!-- OTA 韌體更新 -->
  <div class="section">
    <h2>OTA 韌體更新</h2>
    <input type="file" id="firmwareInput">
    <button id="uploadBtn">上傳並更新</button>
    <p id="uploadStatus"></p>
  </div>

  <!-- SPIFFS 檔案總管 -->
  <div class="section">
    <h2>SPIFFS 檔案總管</h2>
    <ul id="fileList"></ul>

    <h3>上傳檔案</h3>
    <input type="file" id="fileInput">
    <button id="fileUploadBtn">上傳</button>
    <p id="fileStatus"></p>
  </div>

  <script>
    const ws = new WebSocket(`ws://${location.host}/ws`);
    const current = document.getElementById("current");
    const ledBtn = document.getElementById("ledBtn");

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      current.textContent = `${data.current} A`;
      ledBtn.textContent = data.led ? "LED ON" : "LED OFF";
      ledBtn.style.backgroundColor = data.led ? "#00ffcc" : "#444";
    };

    ledBtn.onclick = () => ws.send("toggleLED");

    // OTA 韌體上傳
    document.getElementById("uploadBtn").onclick = async () => {
      const file = document.getElementById("firmwareInput").files[0];
      if (!file) return alert("請選擇 .bin 檔案");

      const formData = new FormData();
      formData.append("update", file);

      const res = await fetch("/upload", {
        method: "POST",
        body: formData
      });

      document.getElementById("uploadStatus").textContent = await res.text();
    };

    // SPIFFS 檔案列表 + 刪除
    async function refreshFiles() {
      const list = await fetch("/files").then(res => res.json());
      const ul = document.getElementById("fileList");
      ul.innerHTML = "";

      list.forEach(file => {
        const li = document.createElement("li");
        const download = document.createElement("a");
        download.href = file;
        download.textContent = file;
        download.download = "";

        const delBtn = document.createElement("button");
        delBtn.textContent = "刪除";
        delBtn.onclick = async () => {
          await fetch("/delete", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `file=${encodeURIComponent(file)}`
          });
          refreshFiles();
        };

        li.appendChild(download);
        li.appendChild(delBtn);
        ul.appendChild(li);
      });
    }
    refreshFiles();

    // 上傳檔案
    document.getElementById("fileUploadBtn").onclick = async () => {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("請選擇檔案");

      const formData = new FormData();
      formData.append("file", file);

      const res = await fetch("/uploadFile", {
        method: "POST",
        body: formData
      });

      document.getElementById("fileStatus").textContent = await res.text();
      refreshFiles();
    };
  </script>
</body>
</html>
